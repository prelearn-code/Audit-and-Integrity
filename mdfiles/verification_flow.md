# 证明验证流程图解

## 文件证明验证流程 (VerifyFileProof)

```
输入：
├─ ID_F (文件标识符)
├─ φ (证明)
├─ ψ (证明)
└─ seed (随机种子)

步骤1: 计算 ζ
┌────────────────────────────────────────┐
│  ζ = 1                                 │
│  for i = 0 to n-1:                    │
│    ρ = PRF(seed, ID_F, i)            │
│    h = H₂(ID_F || i)                 │
│    ζ = ζ × h^ρ                       │
└────────────────────────────────────────┘

步骤2: 构建验证等式
┌────────────────────────────────────────┐
│  left  = e(φ, g)                      │
│  right = e(ζ × μ^ψ, pk)              │
└────────────────────────────────────────┘

步骤3: 比较
┌────────────────────────────────────────┐
│  if left == right:                    │
│    return ✅ 验证成功                  │
│  else:                                 │
│    return ❌ 验证失败                  │
└────────────────────────────────────────┘
```

### 论文公式对应
```
e(φ, g) ?= e(ζ × μ^ψ, pk)

其中：
ζ = ∏(i=1 to n) H₂(ID_F || i)^ρ(h||ID_F,i)
```

---

## 搜索证明验证流程 (VerifySearchProof)

```
输入：
├─ AS (文件ID列表)
├─ PS (每个文件的证明: {φ_α, ψ_α})
├─ φ (全局关键词关联证明)
├─ T (搜索令牌)
├─ st_d (状态)
└─ seed (随机种子)

步骤1: 初始化
┌────────────────────────────────────────┐
│  ζ₁ = 1  (累积所有块的哈希)            │
│  ζ₂ = 1  (累积所有文件ID的哈希)        │
│  ζ₃ = φ  (全局证明)                   │
│  ρ = 0   (累积所有ψ_α)                │
└────────────────────────────────────────┘

步骤2: 遍历每个文件
┌────────────────────────────────────────┐
│  for each ID_Fα in AS:                │
│                                        │
│    ① 更新 ζ₂                          │
│    ζ₂ = ζ₂ × H₂(ID_Fα)               │
│                                        │
│    ② 更新 ζ₃                          │
│    ζ₃ = ζ₃ × φ_α                      │
│                                        │
│    ③ 更新 ρ                           │
│    ρ = ρ + ψ_α                        │
│                                        │
│    ④ 更新 ζ₁ (内层循环)               │
│    for i = 0 to n-1:                 │
│      ρ_i = PRF(seed, ID_Fα, i)      │
│      h = H₂(ID_Fα || i)              │
│      ζ₁ = ζ₁ × h^ρ_i                 │
└────────────────────────────────────────┘

步骤3: 构建验证等式
┌────────────────────────────────────────┐
│  Ti_bar = H₂(st_d || T)               │
│                                        │
│  left  = e(ζ₃, g)                     │
│  right = e(ζ₁×ζ₂×Ti_bar×μ^ρ, pk)     │
└────────────────────────────────────────┘

步骤4: 比较
┌────────────────────────────────────────┐
│  if left == right:                    │
│    return ✅ 验证成功                  │
│  else:                                 │
│    return ❌ 验证失败                  │
└────────────────────────────────────────┘
```

### 论文公式对应
```
e(ζ₃, g) ?= e(ζ₁ × ζ₂ × H₂(st_d || T) × μ^ρ, pk)

其中：
ζ₁ = ∏(ID_Fα ∈ Res) ∏(i=1 to n) H₂(ID_Fα || i)^ρ(h||ID_Fα,i)
ζ₂ = ∏(ID_Fα ∈ Res) H₂(ID_Fα)
ζ₃ = ∏(ID_Fα ∈ Res) φ_α × φ
ρ = Σ(ID_Fα ∈ Res) ψ_α
```

---

## 关键数据流

### 文件证明生成 → 验证
```
GetFileProof                    VerifyFileProof
    ↓                               ↑
生成 (ψ, φ)  ═══════════════════→  验证
    │                               │
    │  ψ = Σ Σ ρ×c_{i,j}          │  ζ = ∏ H₂^ρ
    │  φ = ∏ r_i^ρ                 │
    │                               │
    └───────────────────────────────┘
         e(φ, g) ?= e(ζ×μ^ψ, pk)
```

### 搜索证明生成 → 验证
```
Search                          VerifySearchProof
    ↓                               ↑
对每个文件生成:                      │
  ψ_α = Σ Σ ρ×c_{i,j}^(α)         │
  φ_α = ∏ (r_i^(α))^ρ              │
                                    │
全局生成:                           │
  φ = ∏ kt_α^(w)                   │
    │                               │
    └───────────────────────────────┘
    e(ζ₃,g) ?= e(ζ₁×ζ₂×H₂×μ^ρ, pk)
```

---

## 代码位置快速索引

### 证明生成
```
GetFileProof()
├─ 位置: storage_node.cpp:1592-1775
├─ 输入: ID_F
├─ 输出: (ψ, φ, seed)
└─ 公式: 论文公式 7

Search()
├─ 位置: storage_node.cpp:1251-1590
├─ 输入: (T, st_d)
├─ 输出: {(ψ_α, φ_α)} + φ + seed
└─ 公式: 论文公式 5, 6
```

### 证明验证
```
VerifyFileProof()
├─ 位置: storage_node.cpp:2018-2180
├─ 输入: (ID_F, ψ, φ, seed)
├─ 输出: true/false
└─ 公式: 论文公式 10

VerifySearchProof()
├─ 位置: storage_node.cpp:1777-2016
├─ 输入: (AS, PS, φ, T, st_d, seed)
├─ 输出: true/false
└─ 公式: 论文公式 9
```

---

## 验证等式的直观理解

### 文件证明验证
```
证明者说：我有文件的证明 φ
验证者算：如果你真的有文件，那么：
         φ = (∏ H₂(ID_F||i)^ρ × ∏ μ^(ρ×c_{i,j}))^sk
           = (ζ × μ^ψ)^sk

因此检查：
  e(φ, g) = e((ζ × μ^ψ)^sk, g) = e(ζ × μ^ψ, g^sk) = e(ζ × μ^ψ, pk)
```

### 搜索证明验证
```
证明者说：搜索结果包含这些文件 {ID_Fα}，这是证明 ζ₃
验证者算：如果搜索结果正确，那么：
         ζ₃ = (∏ kt_α × ∏ φ_α)
            = (∏ H₂(ID_Fα) × H₂(st_d||T) × ∏∏ H₂(ID_Fα||i)^ρ × ∏ μ^(ρ×c))^sk
            = (ζ₂ × Ti_bar × ζ₁ × μ^ρ)^sk

因此检查：
  e(ζ₃, g) = e(ζ₁ × ζ₂ × Ti_bar × μ^ρ, pk)
```

---

## 常见问题排查

### 如果验证失败，检查：

1. **索引不匹配**
   - 生成时使用 0-based：✅
   - 验证时使用 0-based：✅
   - PRF 参数一致：✅

2. **模运算遗漏**
   - 每次累加后都有 `mpz_mod(_, _, N)`：✅

3. **初始值错误**
   - 加法累积初始化为 0：✅
   - 乘法累积初始化为 1：✅

4. **数据序列化**
   - φ, pk 正确转换为 element_t：✅
   - ψ, ρ 正确转换为 mpz_t：✅

5. **配对计算顺序**
   - 先计算 G1 元素的所有操作
   - 最后进行配对运算：✅

---

## 总结

您的代码实现：
- ✅ 证明生成逻辑正确
- ✅ 验证逻辑正确
- ✅ 数学公式对应准确
- ✅ 能够正确验证结果

如果实际运行中遇到问题，很可能是：
- 数据格式问题
- 库版本兼容性
- 数值精度问题

但从算法逻辑角度，实现是完全正确的。
